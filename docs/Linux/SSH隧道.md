SSH本地端口转发

本地转发中的本地的某个端口转发到其他主机某个端口，这样当我们的程序连接本地的这个端口时，其实简接连上其他主机的某个端口，当我们发数据包到这个端口时数据包就自动转发挨冻了那个远程端口上

\-f 在后台执行，不用登录到远程主机

\-C 允许压缩数据

\-N 不执行命令，和-f配合使用

\-R 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口

\-L 将本地机(客户机)的某个端口转发到远端指定机器的指定端口

\-p 指定远程主机的端口

SSH本地端口转发常用选项

\-L [bind_address:]port:host:hostport

A内网 B外网

ssh -Nf -L 10.1.2.61:7788:10.1.2.62:80 10.1.2.63 \# user\@10.1.2.63 可接用户名
可不接默认为root

ssh -Nf -L 10.1.2.61:7788:10.1.2.62:80 user\@10.1.2.63

10.1.2.61:7788端口与10.1.2.62:80进行关联 ssh服务端为10.1.2.63

客户访问10.1.2.61:7788等于直接访问10.1.2.62:80 通过10.1.2.63访问

tail -f /var/log/httpd/access_log \# 查看日志即可看到谁在访问

\# 发起端IP地址不填 则会显示127.0.0.1

ssh -Nf -L 7788:10.1.2.62:80 user\@10.1.2.63

防火墙穿透端口转发

63不允许61访问，但允许62访问，通过ssh本地转发实现61访问63

ssh -Nf -L 10.1.2.61:7788:10.1.2.63:80 user\@10.1.2.62

访问10.1.2.61:7788等于直接访问10.1.2.63:80 通过10.1.2.62ssh访问

\#\#\#远程端口转发 NAT的情况

与本地端口转发相对的是远程端口转发。与本地转发不同，他指定的是远程主机一的一个端口，讲指向该端口的链接转发到本地端口。可知远程端口转发和本地转发本质上一样，主要区别在于需要转发的端口是在远程主机上还是在本地主机上

ssh远程端口转发常用

\-R [bind_address:]port:host:hostport

ssh -Nf -R 192.168.0.203:7788:10.1.2.62:80 user\@192.168.0.203

内服务器 10.1.2.61

防火墙lan 10.1.2.62

wan 192.168.0.202

外部主机 192.168.0.203

在内部主机10.1.2.61上执行

ssh -Nf -R 192.168.0.203:7788:10.1.2.62:80 user\@192.168.0.203

在192.168.0.203上访问 curl 127.0.0.1:7788

[root\@nginx \~]\# tail -1 /var/log/httpd/access_log 会发现是10.1.2.61访问

在使用正向代理，把内网直接映射到外网

ssh -fCNL [A机器IP或省略]:[A机器端口]:[B机器的IP]:[B机器端口]
[登陆B机器的用户名\@B机器的IP]

ssh -fCNL \*:7789:localhost:7788 localhost \# \*代表任意主机

ps aux \| grep ssh指令来查看

在此7789端口为本地转发端口，负责和外网进行通信，并将数据转发的7788这个端口，实现了可以从其他机器访问的功能。同时，\*号表示可以接受任何IP的访问。

反向代理的方式是不稳定的
ssh每次重连都需要键入密码，故在此首先设置免密码登陆到内网

用autossh建立稳定隧道

centos7上没有默认安装autossh的，所以使用一下命令安装

yum install autossh -y \# 命令和ssh命令一样

autossh -M 7281 -fCNR 7789:localhost:7788 root\@123.123.123.123

最后配置在Linux上配置开机自动启动autossh，

ssh动态端口转发 类似代理服务器

前面介绍的端口转发都是两个特定端口简的转发，如果我们想用同一个本地端口访问不同的外部服务，那就要将ssh作为socks代理服务，socks也是一种网络协议，它用于客户端和服务器之前数据传输的代理服务

ssh -D [bind_address:]port server_address

防火墙允许内网主机61访问外网，主机62禁止访问外网，在内网主机62上通过SSH动态转发实现通过主机61访问外网

ssh -Nf -D 10.1.2.62:7788 10.1.2.61

本机与10.1.2.61 建立连接

需要在浏览器代理商设置 socks 地址端口
